#!/bin/sh -e

APP_NAME="_APP_NAME_"
APP_SAFE_NAME="_APP_SAFE_NAME_"

# Source debconf library.
. /usr/share/debconf/confmodule
db_capb backup

db_input high ${APP_NAME}/mysql/autoinstall || true
if [ "$RET" = "false" ]; then
  exit 0
fi


STATE=1 
while [ "$STATE" != 0 -a "$STATE" != 3 ]; do
    case "$STATE" in
    1)
	db_beginblock
	db_input high ${APP_NAME}/mysql/db_host || true
	db_input high ${APP_NAME}/mysql/db_port || true	        
	db_input high ${APP_NAME}/mysql/admin_username || true
	db_input high ${APP_NAME}/mysql/admin_password || true
	db_endblock
    ;;

    2)
	db_beginblock
	db_input medium ${APP_NAME}/mysql/db_username || true
	db_input medium ${APP_NAME}/mysql/db_password || true
	db_input medium ${APP_NAME}/mysql/db_name || true
	db_endblock
    ;;

    3)
	db_get ${APP_NAME}/mysql/db_host
	dbc_host="$RET"

	if [ "$dbc_host" = "127.0.0.1" ] || [ "$dbc_host" = "localhost" ]; then
	    db_set ${APP_NAME}/mysql/db_source_host "${dbc_host}"
	else
	    db_set ${APP_NAME}/mysql/db_source_host "$(hostname -f)"
	fi

	db_fset ${APP_NAME}/mysql/db_source_host seen false
	db_input high ${APP_NAME}/mysql/db_source_host || true
    ;;
    esac

    if db_go; then
        STATE=$(($STATE + 1))
    else
        STATE=$(($STATE - 1))
    fi
done


db_get ${APP_NAME}/mysql/db_port
dbc_port="$RET"
db_get ${APP_NAME}/mysql/admin_username
dbc_admin_username="$RET"
db_get ${APP_NAME}/mysql/admin_password
dbc_admin_password="$RET"

tmpfile=$(mktemp)
cat > $tmpfile <<CONFIG
[client]
password="${dbc_admin_password}"
user="${dbc_admin_user}"
host="${dbc_host}"
port="${dbc_port}"
CONFIG

set +e
test_connection=$(mysql --defaults-file="$tmpfile" -e "select count(*) from mysql.user;")
test_status=$?

rm -f "$tmpfile"

if [ $test_status -eq 0 ]; then
  echo "MySQL connection OK"
else
  echo "$test_connection"
  db_input high ${APP_NAME}/mysql/connection_failed || true
  db_go
  exit 1
fi
set -e

db_get ${APP_NAME}/mysql/db_password
if [ "$RET" = "" ]; then
  dbc_password=$(< /dev/urandom tr -dc A-Za-z0-9 | head -c32;echo;)
  db_set ${APP_NAME}/mysql/db_password "$dbc_password"
fi

